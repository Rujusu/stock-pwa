<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('âœ… Service Worker registered!'));
    }
  </script>
  <meta charset="UTF-8">
  <title>Simple Stock Counter</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { padding: 5px 10px; margin: 0 2px; }
    .critical { background-color: #ffcccc; }
    .low { background-color: #fff3cd; }
    .ok { background-color: #d4edda; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBFg4ymrKuW1M6hETjsVOt-eB7_7Gohcw",
      authDomain: "pos-system-f6930.firebaseapp.com",
      projectId: "pos-system-f6930",
      storageBucket: "pos-system-f6930.appspot.com",
      messagingSenderId: "753361295709",
      appId: "1:753361295709:web:bbb5e062470a9d9a94b0b4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockRef = collection(db, 'stock');

    let stock = [];

    async function loadStock() {
      stock = [];
      const snapshot = await getDocs(stockRef);
      snapshot.forEach(docSnap => {
        stock.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderTable();
      renderSummary();
    }

    async function saveItem(name, qty, low = 5, ok = 10) {
      await addDoc(stockRef, { name, qty, low, ok });
      loadStock();
    }

    async function updateQty(id, newQty) {
      const itemRef = doc(db, 'stock', id);
      await updateDoc(itemRef, { qty: newQty });
      loadStock();
    }

    async function updateThresholds(id, low, ok) {
      const itemRef = doc(db, 'stock', id);
      await updateDoc(itemRef, { low, ok });
      loadStock();
    }

    async function deleteItem(id) {
      const itemRef = doc(db, 'stock', id);
      await deleteDoc(itemRef);
      loadStock();
    }

    function getStatusClass(item) {
      if (item.qty < item.low) return 'critical';
      if (item.qty < item.ok) return 'low';
      return 'ok';
    }

    function renderTable() {
      const tbody = document.querySelector("#stockTable tbody");
      tbody.innerHTML = "";

      stock.forEach((item) => {
        const row = document.createElement("tr");
        row.className = getStatusClass(item);
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>
            <input type="number" value="${item.low}" min="0" style="width:50px" onchange="updateItemThreshold('${item.id}', this.value, 'low')"> Low<br>
            <input type="number" value="${item.ok}" min="0" style="width:50px" onchange="updateItemThreshold('${item.id}', this.value, 'ok')"> OK
          </td>
          <td>
            <button onclick="changeQty('${item.id}', ${item.qty}, 1)">+</button>
            <button onclick="changeQty('${item.id}', ${item.qty}, -1)">-</button>
            <button onclick="removeItem('${item.id}')">Delete</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    function renderSummary() {
      const summary = { critical: 0, low: 0, ok: 0 };
      stock.forEach(item => {
        const cls = getStatusClass(item);
        summary[cls]++;
      });
      document.getElementById("summary").innerText = `Critical: ${summary.critical} | Low: ${summary.low} | OK: ${summary.ok}`;
    }

    async function addItem() {
      const name = document.getElementById("itemName").value.trim();
      const qty = parseInt(document.getElementById("itemQty").value);
      const low = parseInt(document.getElementById("lowQty").value);
      const ok = parseInt(document.getElementById("okQty").value);
      if (!name || isNaN(qty) || isNaN(low) || isNaN(ok)) return alert("Enter valid inputs");
      await saveItem(name, qty, low, ok);
      document.getElementById("itemName").value = "";
      document.getElementById("itemQty").value = 1;
      document.getElementById("lowQty").value = 5;
      document.getElementById("okQty").value = 10;
    }

    function exportCSV() {
      let csv = 'Item,Quantity\n';
      stock.forEach(item => {
        csv += `${item.name},${item.qty}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stock.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.changeQty = async function (id, currentQty, delta) {
      const newQty = Math.max(0, currentQty + delta);
      await updateQty(id, newQty);
    }

    window.removeItem = async function (id) {
      await deleteItem(id);
    }

    window.updateItemThreshold = async function (id, value, type) {
      const item = stock.find(i => i.id === id);
      if (!item) return;
      const low = type === 'low' ? parseInt(value) : item.low;
      const ok = type === 'ok' ? parseInt(value) : item.ok;
      await updateThresholds(id, low, ok);
    }

    document.getElementById("addBtn").addEventListener("click", addItem);
    document.getElementById("exportBtn").addEventListener("click", exportCSV);

    loadStock();
  </script>
</head>
<body>
  <h1>Stock Counting System</h1>

  <label>Item Name: <input id="itemName" type="text"></label>
  <label>Quantity: <input id="itemQty" type="number" value="1"></label>
  <label>Low: <input id="lowQty" type="number" value="5"></label>
  <label>OK: <input id="okQty" type="number" value="10"></label>
  <button id="addBtn">Add Item</button>
  <button id="exportBtn">Export CSV</button>

  <p id="summary" style="margin-top: 10px; font-weight: bold;"></p>

  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
        <th>Thresholds</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
