<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('âœ… Service Worker registered!'));
    }
  </script>
  <meta charset="UTF-8">
  <title>Simple Stock Counter</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { padding: 5px 10px; margin: 0 2px; }
    .critical { background-color: #ffcccc; }
    .low { background-color: #fff3cd; }
    .ok { background-color: #d4edda; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBFg4ymrKuW1M6hETjsVOt-eB7_7Gohcw",
      authDomain: "pos-system-f6930.firebaseapp.com",
      projectId: "pos-system-f6930",
      storageBucket: "pos-system-f6930.appspot.com",
      messagingSenderId: "753361295709",
      appId: "1:753361295709:web:bbb5e062470a9d9a94b0b4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockRef = collection(db, 'stock');

    let stock = [];
    let activeCategory = "All";

    async function loadStock() {
      stock = [];
      const snapshot = await getDocs(stockRef);
      snapshot.forEach(docSnap => {
        stock.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderCategoryOptions();
      renderTable();
      renderSummary();
    }

    async function saveItem(name, qty, critical = 2, low = 5, ok = 10, category = "Uncategorized") {
      await addDoc(stockRef, { name, qty, critical, low, ok, category });
      loadStock();
    }

    async function updateQty(id, newQty) {
      const itemRef = doc(db, 'stock', id);
      await updateDoc(itemRef, { qty: newQty });
      loadStock();
    }

    async function updateThresholds(id, critical, low, ok) {
      const itemRef = doc(db, 'stock', id);
      await updateDoc(itemRef, { critical, low, ok });
      loadStock();
    }

    async function deleteItem(id) {
      const itemRef = doc(db, 'stock', id);
      await deleteDoc(itemRef);
      loadStock();
    }

    function getStatusClass(item) {
      if (item.qty < item.critical) return 'critical';
      if (item.qty < item.low) return 'low';
      return 'ok';
    }

    function renderCategoryOptions() {
      const categorySet = new Set(stock.map(item => item.category || "Uncategorized"));
      const categorySelect = document.getElementById("categoryFilter");
      categorySelect.innerHTML = '<option value="All">All</option>';
      [...categorySet].sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
      categorySelect.value = activeCategory;
    }

    function renderTable() {
      const tbody = document.querySelector("#stockTable tbody");
      tbody.innerHTML = "";

      const filtered = activeCategory === "All" ? stock : stock.filter(i => i.category === activeCategory);

      filtered.forEach((item) => {
        const row = document.createElement("tr");
        row.className = getStatusClass(item);
        row.innerHTML = `
          <td>${item.name}<br><small>${item.category || "Uncategorized"}</small></td>
          <td>${item.qty}</td>
          <td>
            <label>Critical:<input type="number" value="${item.critical}" min="0" style="width:50px" onchange="updateItemThreshold('${item.id}', this.value, 'critical')"></label><br>
            <label>Low:<input type="number" value="${item.low}" min="0" style="width:50px" onchange="updateItemThreshold('${item.id}', this.value, 'low')"></label><br>
            <label>OK:<input type="number" value="${item.ok}" min="0" style="width:50px" onchange="updateItemThreshold('${item.id}', this.value, 'ok')"></label>
          </td>
          <td>
            <button onclick="changeQty('${item.id}', ${item.qty}, 1)">+</button>
            <button onclick="changeQty('${item.id}', ${item.qty}, -1)">-</button>
            <button onclick="removeItem('${item.id}')">Delete</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    function renderSummary() {
      const summary = { critical: 0, low: 0, ok: 0 };
      stock.forEach(item => {
        const cls = getStatusClass(item);
        summary[cls]++;
      });
      document.getElementById("summary").innerText = `Critical: ${summary.critical} | Low: ${summary.low} | OK: ${summary.ok}`;
    }

    async function addItem() {
      const name = document.getElementById("itemName").value.trim();
      const qty = parseInt(document.getElementById("itemQty").value);
      const critical = parseInt(document.getElementById("criticalQty").value);
      const low = parseInt(document.getElementById("lowQty").value);
      const ok = parseInt(document.getElementById("okQty").value);
      const category = document.getElementById("itemCategory").value.trim() || "Uncategorized";
      if (!name || isNaN(qty) || isNaN(critical) || isNaN(low) || isNaN(ok)) return alert("Enter valid inputs");
      await saveItem(name, qty, critical, low, ok, category);
      document.getElementById("itemName").value = "";
      document.getElementById("itemQty").value = 1;
      document.getElementById("criticalQty").value = 2;
      document.getElementById("lowQty").value = 5;
      document.getElementById("okQty").value = 10;
      document.getElementById("itemCategory").value = "";
    }

    function exportCSV() {
      let csv = 'Item,Quantity,Category\n';
      stock.forEach(item => {
        csv += `${item.name},${item.qty},${item.category || ""}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stock.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    window.changeQty = async function (id, currentQty, delta) {
      const newQty = Math.max(0, currentQty + delta);
      await updateQty(id, newQty);
    }

    window.removeItem = async function (id) {
      await deleteItem(id);
    }

    window.updateItemThreshold = async function (id, value, type) {
      const item = stock.find(i => i.id === id);
      if (!item) return;
      const critical = type === 'critical' ? parseInt(value) : item.critical;
      const low = type === 'low' ? parseInt(value) : item.low;
      const ok = type === 'ok' ? parseInt(value) : item.ok;
      await updateThresholds(id, critical, low, ok);
    }

    window.setCategoryFilter = function (value) {
      activeCategory = value;
      renderTable();
      renderSummary();
    }

    document.getElementById("addBtn").addEventListener("click", addItem);
    document.getElementById("exportBtn").addEventListener("click", exportCSV);
    document.getElementById("categoryFilter").addEventListener("change", e => setCategoryFilter(e.target.value));

    loadStock();
  </script>
</head>
<body>
  <h1>Stock Counting System</h1>

  <label>Item Name: <input id="itemName" type="text"></label>
  <label>Quantity: <input id="itemQty" type="number" value="1"></label>
  <label>Critical: <input id="criticalQty" type="number" value="2"></label>
  <label>Low: <input id="lowQty" type="number" value="5"></label>
  <label>OK: <input id="okQty" type="number" value="10"></label>
  <label>Category: <input id="itemCategory" type="text" placeholder="e.g. Snacks"></label>
  <button id="addBtn">Add Item</button>
  <button id="exportBtn">Export CSV</button>

  <p>
    Filter by Category:
    <select id="categoryFilter"></select>
  </p>

  <p id="summary" style="margin-top: 10px; font-weight: bold;"></p>

  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
        <th>Thresholds</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
