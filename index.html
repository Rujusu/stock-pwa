<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <title>Stock Counting System</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { padding: 5px 10px; margin: 0 2px; }
    .critical { background-color: #ffcccc; }
    .low { background-color: #fff3cd; }
    .ok { background-color: #d4edda; }
    .hidden { display: none; }
    nav { margin-bottom: 20px; }
    nav a { margin-right: 15px; text-decoration: none; font-weight: bold; }
  </style>
</head>
<body>
  <div id="loginForm">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
  </div>

  <div id="app" class="hidden">
    <h1>Stock Counting System</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="recipes.html" id="recipesLink" class="hidden">Recipes</a>
      <button id="logoutBtn" class="hidden" style="float:right">Logout</button>
    </nav>

    <div id="adminTools" class="hidden">
      <label>Item Name: <input id="itemName" type="text"></label>
      <label>Quantity: <input id="itemQty" type="number" value="1"></label>
      <label>Unit Value (e.g. 700): <input id="itemUnitValue" type="number" value="1"></label>
      <label>Unit Label:
        <select id="itemUnitLabel">
          <option value="ml">ml</option>
          <option value="g">g</option>
          <option value="units">units</option>
          <option value="">(none)</option>
        </select>
      </label>
      <label>Critical: <input id="criticalQty" type="number" value="2"></label>
      <label>Low: <input id="lowQty" type="number" value="5"></label>
      <label>Category: <input id="itemCategory" type="text" placeholder="e.g. Drinks"></label>
      <button id="addItemBtn">Add Item</button>
    </div>

    <p>
      Filter by Category:
      <select id="categoryFilter" onchange="setCategoryFilter(this.value)"></select>
      <label>Search: <input id="searchBox" type="text" placeholder="Search by name" oninput="setSearchQuery(this.value)"></label>
    </p>

    <p id="summary" style="margin-top: 10px; font-weight: bold;"></p>

    <table id="stockTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity Ã— Unit = Total</th>
          <th>Thresholds</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBFg4ymrKuW1M6hETjsVOt-eB7_7Gohcw",
      authDomain: "pos-system-f6930.firebaseapp.com",
      projectId: "pos-system-f6930",
      storageBucket: "pos-system-f6930.appspot.com",
      messagingSenderId: "753361295709",
      appId: "1:753361295709:web:bbb5e062470a9d9a94b0b4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const stockRef = collection(db, 'stock');

    let stock = [];
    let activeCategory = "All";
    let searchQuery = "";
    let currentUser = null;
    let currentRole = "staff";

    async function loadStock() {
      stock = [];
      const snapshot = await getDocs(stockRef);
      snapshot.forEach(docSnap => {
        stock.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderCategoryOptions();
      renderTable();
      renderSummary();
    }

    window.addItem = async function () {
      const name = document.getElementById("itemName").value.trim();
      const qty = parseInt(document.getElementById("itemQty").value);
      const unitValue = parseFloat(document.getElementById("itemUnitValue").value);
      const unitLabel = document.getElementById("itemUnitLabel").value.trim();
      const critical = parseInt(document.getElementById("criticalQty").value);
      const low = parseInt(document.getElementById("lowQty").value);
      const category = document.getElementById("itemCategory").value.trim() || "Uncategorized";
      if (!name || isNaN(qty) || isNaN(unitValue) || isNaN(critical) || isNaN(low)) return alert("Enter valid inputs");
      const total = qty * unitValue;
      await addDoc(stockRef, { name, qty, unitValue, unitLabel, total, critical, low, category });
      document.getElementById("itemName").value = "";
      document.getElementById("itemQty").value = 1;
      document.getElementById("itemUnitValue").value = 1;
      document.getElementById("itemUnitLabel").value = "ml";
      document.getElementById("criticalQty").value = 2;
      document.getElementById("lowQty").value = 5;
      document.getElementById("itemCategory").value = "";
      loadStock();
    }

    window.setCategoryFilter = function (value) {
      activeCategory = value;
      renderTable();
      renderSummary();
    }

    window.setSearchQuery = function (value) {
      searchQuery = value;
      renderTable();
      renderSummary();
    }

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const result = await signInWithEmailAndPassword(auth, email, password);
        currentUser = result.user;
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        currentRole = userDoc.exists() ? userDoc.data().role : 'staff';

        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");

        if (currentRole === 'admin') {
          document.getElementById("adminTools").classList.remove("hidden");
          document.getElementById("recipesLink").classList.remove("hidden");
        }

        loadStock();
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      location.href = "index.html";
    });

    document.getElementById("addItemBtn").addEventListener("click", () => window.addItem());
  </script>
</body>
</html>
